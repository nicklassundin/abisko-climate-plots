<!doctype html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/js/modules/annotations.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts-more.js"></script>
    <script src="regression.js"></script>
    <script src="papaparse.min.js"></script>
    <script src="helpers.js"></script>
    <style type="text/css">
        body {
            text-align: center;
        }

        .figure {
            min-width: 500px;
            max-width: 800px;
            height: 340px;
        }
    </style>
</head>

<body>
    <div id="abiskoTemperatures" class="figure"></div>
    <div id="northernHemisphere" class="figure"></div>
    <div id="globalTemperatures" class="figure"></div>

    <div id="temperatureDifferenceAbisko" class="figure"></div>
    <div id="temperatureDifference1" class="figure"></div>
    <div id="temperatureDifference2" class="figure"></div>
    <div id="temperatureDifference3" class="figure"></div>

    <div id="yearlyPrecipitation" class="figure"></div>
    <div id="monthlyPrecipitation_jan" class="figure"></div>
    <div id="monthlyPrecipitation_feb" class="figure"></div>
    <div id="monthlyPrecipitation_mar" class="figure"></div>
    <div id="monthlyPrecipitation_apr" class="figure"></div>
    <div id="monthlyPrecipitation_may" class="figure"></div>
    <div id="monthlyPrecipitation_jun" class="figure"></div>
    <div id="monthlyPrecipitation_jul" class="figure"></div>
    <div id="monthlyPrecipitation_aug" class="figure"></div>
    <div id="monthlyPrecipitation_sep" class="figure"></div>
    <div id="monthlyPrecipitation_oct" class="figure"></div>
    <div id="monthlyPrecipitation_nov" class="figure"></div>
    <div id="monthlyPrecipitation_dec" class="figure"></div>

    <div id="lakeIce" class="figure"></div>

    <script type="text/javascript">
        Highcharts.setOptions({
            credits: false,
        });

        var renderTemperatureGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'line',
                    zoomType: 'xy',
                },
                title: {
                    text: title,
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Temperature [C째]'
                    },
                    plotLines: [{
                        value: 0,
                        color: 'rgb(204, 214, 235)',
                        width: 2,
                    }],
                    //max: 2,
                    //min: -3,
                    tickInterval: 1,
                    lineWidth: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' 째C',
                    valueDecimals: 2,
                },
                series: [{
                    name: 'Max',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#ff0000',
                    data: temperatures.max,
                }, {
                    name: 'Min',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#0000ff',
                    data: temperatures.min,
                }, {
                    name: 'Yearly average',
                    lineWidth: 0,
                    marker: { radius: 2 },
                    states: { hover: { lineWidthPlus: 0 } },
                    color: '#888888',
                    data: temperatures.avg,
                    visible: false,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#888888',
                    data: temperatures.ci,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                    visible: false,
                }, {
                    name: 'Moving average',
                    color: '#888888',
                    marker: { enabled: false },
                    data: temperatures.movAvg,
                }, {
                    name: 'Confidence interval',
                    type: 'arearange',
                    color: '#7777ff',
                    data: temperatures.ciMovAvg,
                    zIndex: 0,
                    fillOpacity: 0.3,
                    lineWidth: 0,
                    states: { hover: { lineWidthPlus: 0 } },
                    marker: { enabled: false },
                }],
            });
        };

        var parseGISSTEMP = function (results) {
            var fields = results.meta.fields;
            var temperatures = [];

            results.data.forEach(function (row) {
                var year = {
                    min: Infinity,
                    max: -Infinity,
                    sum: 0,
                    count: 0,
                };

                fields.forEach(function (field) {
                    year[field.toLowerCase()] = validNumber(row[field]);
                });

                var monthlyTemperatures = months().map(function (month) {
                    return year[month];
                }).filter(Number);

                monthlyTemperatures.forEach(function (temperature) {
                    year.min = Math.min(year.min, temperature);
                    year.max = Math.max(year.max, temperature);
                    year.sum += temperature;
                    year.count++;
                });

                if (year.count > 0) {
                    year.avg = year.sum / year.count;

                    year.variance = 0;

                    if (year.count > 1) {
                        year.variance = variance(monthlyTemperatures);
                    }

                    year.ci = confidenceInterval(year.avg, year.variance, year.count);

                    temperatures.push(year);
                }
            });

            ['min', 'max', 'avg'].forEach(function (statistic) {
                temperatures[statistic] = temperatures.map(function (temps) {
                    return {
                        x: temps.year,
                        y: temps[statistic],
                    };
                }).slice(10);
            });

            temperatures.movAvg = movingAverages(temperatures.map(function (temps) {
                return temps.avg;
            }), 10).map(function (avg, index) {
                return {
                    x: temperatures[index].year,
                    y: avg,
                };
            }).slice(10);

            temperatures.ci = temperatures.map(function (temps) {
                return {
                    x: temps.year,
                    low: temps.ci.low,
                    high: temps.ci.high,
                };
            });

            temperatures.ciMovAvg = temperatures.ci.map(function (each) {
                return {
                    x: each.x,
                };
            });

            ['low', 'high'].forEach(function (bound) {
                movingAverages(temperatures.ci.map(function (each) {
                    return each[bound]
                }), 10).forEach(function (value, index) {
                    temperatures.ciMovAvg[index][bound] = value;
                });
            });

            temperatures.ci = temperatures.ci.slice(10);
            temperatures.ciMovAvg = temperatures.ciMovAvg.slice(10);

            return temperatures;
        };

        var parseAbiskoCsv = function (result) {
            var rows = result.data;

            var fields = {
                time: result.meta.fields[0],
                avg: result.meta.fields[1],
                min: result.meta.fields[2],
                max: result.meta.fields[3],
                precip: result.meta.fields[4],
            };

            var data = {};

            rows.forEach(function (row) {
                var date = parseDate(row[fields.time]);
                var avg = parseNumber(row[fields.avg]);
                var min = parseNumber(row[fields.min]);
                var max = parseNumber(row[fields.max]);
                var precip = parseNumber(row[fields.precip]);
                var year = data[date.year] = data[date.year] || {
                    sum: 0,
                    count: 0,
                    precip: 0,
                    precip_snow: 0,
                    precip_rain: 0,
                    data: [],
                };
                if (avg) {
                    year.sum += avg;
                    year.count++;
                }
                if (precip) {
                    year.precip += precip;
                    if (avg < 0) {
                        year.precip_snow += precip;
                    } else {
                        year.precip_rain += precip;
                    }
                }
                year.data.push({
                    date: date,
                    avg: avg,
                    min: min,
                    max, max,
                    precip: precip,
                    precip_snow: (avg < 0) ? precip : 0,
                    precip_rain: (avg >= 0) ? precip : 0,
                });
            });

            var baseline = {
                sum: 0,
                count: 0,
            };

            Object.entries(data).forEach(function (each) {
                var year = each[1];
                year.avg = year.sum / (year.count || 1);

                if (isBaselinePeriod(each[0])) {
                    baseline.sum += year.avg;
                    baseline.count++;
                }

                var monthlyTemperatures = [];
                var monthlyPrecipitation = [];

                year.data.forEach(function (each) {
                    var month = +each.date.month;
                    var temperatures = monthlyTemperatures[month - 1] = monthlyTemperatures[month - 1] || {
                        sum: 0,
                        count: 0,
                    };
                    var precip = monthlyPrecipitation[month - 1] = monthlyPrecipitation[month - 1] || {
                        sum: 0,
                        rain: 0,
                        snow: 0,
                        count: 0,
                    };
                    if (each.avg) {
                        temperatures.sum += each.avg;
                        temperatures.count++;
                    }
                    if (each.precip) {
                        precip.sum += each.precip;
                        precip.snow += each.precip_snow;
                        precip.rain += each.precip_rain;
                        precip.count++;
                    }
                });

                monthlyTemperatures = monthlyTemperatures.map(function (month) {
                    return month.sum / month.count;
                });

                year.monthlyPrecipitation = monthlyPrecipitation.map(function (precip) {
                    return {
                        avg: precip.sum / precip.count,
                        snow: precip.snow / precip.count,
                        rain: precip.rain / precip.count,
                    };
                });

                year.max = monthlyTemperatures.reduce(function (total, current) {
                    return Math.max(total, current);
                });

                year.min = monthlyTemperatures.reduce(function (total, current) {
                    return Math.min(total, current);
                });

                year.variance = 0;
                year.ci = { low: -Infinity, high: Infinity };

                if (monthlyTemperatures.length > 1) {
                    year.variance = variance(monthlyTemperatures);
                    year.ci = confidenceInterval(year.avg, year.variance, monthlyTemperatures.length);
                }
            });

            baseline.avg = baseline.sum / baseline.count;

            var yearly = function (statistic) {
                return Object.entries(data).map(function (each) {
                    return {
                        x: +each[0],
                        y: each[1][statistic],
                    };
                }).slice(10);
            }

            var years = Object.keys(data).map(Number);

            var avg = yearly('avg');
            var min = yearly('min');
            var max = yearly('max');
            var precip = yearly('precip');
            var precip_snow = yearly('precip_snow');
            var precip_rain = yearly('precip_rain');

            var monthly = function (monthIndex, statistic) {
                return Object.entries(data).map(function (each) {
                    return {
                        x: +each[0],
                        y: each[1].monthlyPrecipitation[monthIndex][statistic]
                    };
                })
            }

            var monthlyPrecip = {};

            months().forEach(function (month, index) {
                var m = monthlyPrecip[month] = monthlyPrecip[month] || {};
                m.years = years.slice(10);
                m.avg = monthly(index, 'avg');
                m.movAvg = movingAverages(m.avg.map(function (each) {
                    return each.y;
                }), 10).map(function (avg, index) {
                    return {
                        x: Object.keys(data)[index],
                        y: avg,
                    }
                }).slice(10);
                m.linear = linearRegression(m.years, m.movAvg.map(function (each) {
                    return each.y
                }));
                m.avg = m.avg.slice(10);
                m.rain = monthly(index, 'rain').slice(10);
                m.snow = monthly(index, 'snow').slice(10);
            });

            var ci = Object.entries(data).map(function (each) {
                return {
                    x: +each[0],
                    low: each[1].ci.low,
                    high: each[1].ci.high,
                };
            });

            var movAvg = movingAverages(Object.values(data).map(function (each) {
                return each.avg;
            }), 10).map(function (avg, index) {
                return {
                    x: Object.keys(data)[index],
                    y: avg,
                };
            }).slice(10);

            var precipMovAvg = movingAverages(Object.values(data).map(function (each) {
                return each.precip;
            }), 10).map(function (avg, index) {
                return {
                    x: Object.keys(data)[index],
                    y: avg,
                };
            }).slice(10);

            var precipitationLinear = linearRegression(years.slice(10), precipMovAvg.map(function (each) {
                return each.y;
            }));

            var ciMovAvg = ci.map(function (each) {
                return {
                    x: each.x,
                };
            });

            ['low', 'high'].forEach(function (bound) {
                movingAverages(ci.map(function (each) {
                    return each[bound]
                }), 10).forEach(function (value, index) {
                    ciMovAvg[index][bound] = value;
                });
            });

            data.difference = avg.map(function (each) {
                return {
                    x: each.x,
                    y: each.y - baseline.avg,
                };
            });

            data.years = years;
            data.avg = avg;
            data.min = min;
            data.max = max;
            data.movAvg = movAvg;
            data.ci = ci.slice(10);
            data.ciMovAvg = ciMovAvg.slice(10);
            data.precip = precip;
            data.precip_snow = precip_snow;
            data.precip_rain = precip_rain;
            data.precip_movAvg = precipMovAvg;
            data.precip_linear = precipitationLinear;
            data.monthlyPrecip = monthlyPrecip;

            return data;
        };

        var parseGISSTEMPzonalMeans = function (results) {
            var fields = results.meta.fields;
            var temperatures = [];
            temperatures['sum64n-90n'] = 0;
            temperatures['sumnhem'] = 0;
            temperatures['sumglob'] = 0;
            var count = 0;

            results.data.forEach(function (row) {
                var year = {};

                fields.forEach(function (field) {
                    year[field.toLowerCase()] = validNumber(row[field]);
                })

                if (isBaselinePeriod(year.year)) {
                    temperatures['sum64n-90n'] += year['64n-90n'];
                    temperatures['sumnhem'] += year['nhem'];
                    temperatures['sumglob'] += year['glob'];
                    count++;
                }
                if (year.year > 1913) {
                    temperatures.push(year);
                }
            });

            temperatures['avg64n-90n'] = temperatures['sum64n-90n'] / count;
            temperatures['avgnhem'] = temperatures['sumnhem'] / count;
            temperatures['avgglob'] = temperatures['sumglob'] / count;

            var difference = function (region) {
                return temperatures.map(function (each) {
                    return {
                        x: each.year,
                        y: each[region] - temperatures['avg' + region],
                    };
                }).slice(9); // remove values missing from Abisko data
            }

            temperatures['64n-90n'] = difference('64n-90n');
            temperatures['nhem'] = difference('nhem');
            temperatures['glob'] = difference('glob');

            return temperatures;
        };

        var renderTemperatureDifferenceGraph = function (temperatures, id, title) {
            Highcharts.chart(id, {
                chart: {
                    type: 'column'
                },
                title: {
                    text: title,
                },
                subtitle: {
                    text: 'Difference between yearly average and average for 1961-1990',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                    plotBands: [{
                        color: 'rgb(245, 245, 245)',
                        from: 1961,
                        to: 1990,
                    }],
                },
                yAxis: {
                    title: {
                        text: 'Temperature [C째]'
                    },
                    lineWidth: 1,
                    min: -2,
                    max: 3,
                    tickInterval: 1,
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' 째C',
                    valueDecimals: 2,
                },
                legend: {
                    enabled: false,
                },
                annotations: [{
                    labelOptions: {
                        barkgroundColor: 'red',
                        verticalAlign: 'top',
                    },
                    labels: [{
                        point: {
                            xAxis: 0,
                            yAxis: 0,
                            x: 1975,
                            y: 2.4,
                        },
                        text: 'Baseline',
                    }],
                }],
                series: [{
                    name: 'Difference',
                    data: temperatures,
                    color: 'red',
                    negativeColor: 'blue',
                }],
            });
        };

        var renderYearlyPrecipitationGraph = function (precipitation) {
            Highcharts.chart('yearlyPrecipitation', {
                chart: {
                    type: 'line'
                },
                title: {
                    text: 'Yearly precipitation',
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Total precipitation [mm]'
                    },
                    lineWidth: 1,
                    floor: 0, // Precipitation can never be negative
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 0,
                    headerFormat: '<span style="font-size: 10px">{point.key}</span><br/>' +
                        '<span style="color: red">\u25CF</span> Linear regression: <b>' + precipitation.precip_linear + '</b><br />' +
                        '<span style="color: white; visibility: hidden">\u25CF</span> Total precipitation: <b>{point.total:.0f} mm</b><br />',
                },
                series: [{
                    name: 'Precipitation from snow',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.precip_snow,
                    color: '#eeeeff',
                    states: {
                        hover: {
                            color: '#aaaaff',
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Precipitation from rain',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.precip_rain,
                    color: '#ccccff',
                    states: {
                        hover: {
                            color: '#0000ff',
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Average precipitation',
                    color: '#888888',
                    data: precipitation.precip_movAvg,
                }, {
                    name: 'Linear regression',
                    marker: {
                        enabled: false, // Linear regression lines doesn't contain points
                    },
                    color: 'red',
                    states: {
                        hover: {
                            lineWidth: 0, // Do nothing on hover
                        },
                    },
                    enableMouseTracking: false, // No interactivity
                    data: [
                        { x: precipitation.years[10], y: precipitation.precip_linear(precipitation.years[10]) },
                        { x: precipitation.years[precipitation.years.length - 1], y: precipitation.precip_linear(precipitation.years[precipitation.years.length - 1]) }
                    ],
                }],
            });
        };

        var renderMonthlyPrecipitationGraph = function (precipitation, month) {
            console.log(precipitation.linear(1))
            var titles = {
                jan: 'January', feb: 'February', mar: 'March', apr: 'April', may: 'May', jun: 'June',
                jul: 'July', aug: 'August', sep: 'September', oct: 'October', nov: 'November', dec: 'December'
            };
            Highcharts.chart('monthlyPrecipitation_' + month, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: 'Precipitation for ' + titles[month],
                },
                xAxis: {
                    title: {
                        text: 'Year',
                    },
                    crosshair: true,
                },
                yAxis: {
                    title: {
                        text: 'Total precipitation [mm]'
                    },
                    lineWidth: 1,
                    max: 10,
                    floor: 0, // Precipitation can never be negative
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' mm',
                    valueDecimals: 0,
                    headerFormat: '<span style="font-size: 10px">{point.key}</span><br/>' +
                        '<span style="color: red">\u25CF</span> Linear regression: <b>' + precipitation.linear + '</b><br />' +
                        '<span style="color: white; visibility: hidden">\u25CF</span> Total precipitation: <b>{point.total:.0f} mm</b><br />',
                },
                series: [{
                    name: 'Precipitation from snow',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.snow,
                    color: '#eeeeff',
                    states: {
                        hover: {
                            color: '#aaaaff',
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Precipitation from rain',
                    type: 'column',
                    stack: 'precip',
                    stacking: 'normal',
                    data: precipitation.rain,
                    color: '#ccccff',
                    states: {
                        hover: {
                            color: '#0000ff',
                            animation: {
                                duration: 0,
                            },
                        },
                    },
                }, {
                    name: 'Average precipitation',
                    color: '#888888',
                    data: precipitation.movAvg,
                }, {
                    name: 'Linear regression',
                    marker: {
                        enabled: false, // Linear regression lines doesn't contain points
                    },
                    color: 'red',
                    states: {
                        hover: {
                            lineWidth: 0, // Do nothing on hover
                        },
                    },
                    enableMouseTracking: false, // No interactivity
                    data: [
                        { x: precipitation.years[0], y: precipitation.linear(precipitation.years[0]) },
                        { x: precipitation.years[precipitation.years.length - 1], y: precipitation.linear(precipitation.years[precipitation.years.length - 1]) }
                    ],
                }],
            });
        };

        /*******************************************/
        /* THE ACTUAL LOADING OF DATA HAPPENS HERE */
        /*******************************************/
        Papa.parse(window.location + '/NH.Ts downloaded 21062018.csv', {
            header: true,
            delimiter: ',',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            comments: 'Station',
            complete: function (result) {
                var temperatures = parseGISSTEMP(result);
                renderTemperatureGraph(temperatures, 'northernHemisphere', 'Northern hemispheric temperatures');
            },
        });

        Papa.parse(window.location + '/GLB.Ts downloaded 21062018.csv', {
            header: true,
            delimiter: ',',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            comments: 'Station',
            complete: function (result) {
                var temperatures = parseGISSTEMP(result);
                renderTemperatureGraph(temperatures, 'globalTemperatures', 'Global temperatures');
            },
        });

        Papa.parse(window.location + '/ZonAnn.Ts+dSST downloaded 21062018.csv', {
            header: true,
            delimiter: ',',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            complete: function (result) {
                var temperatures = parseGISSTEMPzonalMeans(result);
                renderTemperatureDifferenceGraph(temperatures['64n-90n'], 'temperatureDifference1', 'Temperature difference for 64N-90N');
                renderTemperatureDifferenceGraph(temperatures['nhem'], 'temperatureDifference2', 'Temperature difference for nordic hemisphere');
                renderTemperatureDifferenceGraph(temperatures['glob'], 'temperatureDifference3', 'Global temperature difference');
            },
        });

        Papa.parse(window.location + '/ANS_Temp_Prec_1913-2017.csv', {
            header: true,
            //delimiter: ';',
            download: true,
            skipEmptyLines: true,
            dynamicTyping: false,
            complete: function (result) {
                var data = parseAbiskoCsv(result);
                renderTemperatureGraph(data, 'abiskoTemperatures', 'Abisko temperatures');
                renderTemperatureDifferenceGraph(data.difference, 'temperatureDifferenceAbisko', 'Temperature difference for Abisko');
                renderYearlyPrecipitationGraph(data);
                months().forEach(function (month) {
                    renderMonthlyPrecipitationGraph(data.monthlyPrecip[month], month)
                });
            },
        });



        Highcharts.chart('lakeIce', {
            chart: {
                type: 'line'
            },
            title: {
                text: 'Freeze up and break up of lake ice vs ice free time',
            },
            xAxis: {
                title: {
                    text: 'Year',
                },
                crosshair: true,
            },
            yAxis: [{
                title: {
                    text: 'Ice freeze / break up [date]',
                },
                lineWidth: 1,
                floor: 0,
                type: 'datetime',
            }, {
                title: {
                    text: 'Ice free time [days]',
                },
                lineWidth: 1,
                opposite: true,
                floor: 0,
            }],
            tooltip: {
                shared: true,
                valueDecimals: 0,
            },
            series: [{
                yAxis: 0,
                name: 'Ice breaking',
                color: '#ff0000',
                //data: combine(years, movingAverages(precipitation.map(totalPrecipitation), 10)).slice(10), // Remove the first 10
            }, {
                yAxis: 0,
                name: 'Linear regression',
                marker: {
                    enabled: false, // Linear regression lines doesn't contain points
                },
                color: 'red',
                states: {
                    hover: {
                        lineWidth: 0, // Do nothing on hover
                    },
                },
                enableMouseTracking: false, // No interactivity
                //data: [
                //    { x: years[10], y: precipitationLinear(years[10]) },
                //    { x: years[years.length - 1], y: precipitationLinear(years[years.length - 1]) }
                //],
            }],
        });
    </script>
</body>

</html>